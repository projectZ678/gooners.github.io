<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gooning Leaderboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --bg:#0a0a0a;--panel:#111;--text:#eee;--muted:#888;--glow:rgba(255,255,255,.2);
  --accent:#fff;--discord:#5865F2;--transition:300ms ease;
  font-family:"Inter",system-ui,sans-serif;
}
*{box-sizing:border-box}
body{
  margin:0;min-height:100vh;
  background:
    radial-gradient(circle at 30% 20%,rgba(255,255,255,.04),transparent 30%),
    radial-gradient(circle at 80% 80%,rgba(255,255,255,.03),transparent 40%),
    var(--bg);
  color:var(--text);display:flex;align-items:center;justify-content:center;
}
#app,#login-page{width:100%;max-width:800px;padding:24px}
h1{
  text-align:center;font-weight:800;font-size:2rem;letter-spacing:1px;
  color:var(--accent);text-shadow:0 0 20px var(--glow);
}
table{
  width:100%;border-collapse:collapse;margin-top:24px;border-radius:12px;
  overflow:hidden;box-shadow:0 0 40px rgba(0,0,0,.6),0 0 20px rgba(255,255,255,.02) inset;
}
thead{
  background:rgba(255,255,255,.05);text-transform:uppercase;
  font-size:.8rem;letter-spacing:1px;color:var(--muted);
}
th,td{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.05);text-align:left}
tr:hover{
  background:rgba(255,255,255,.03);transform:translateY(-2px);
  box-shadow:0 6px 16px rgba(255,255,255,.03);
  transition:transform var(--transition),box-shadow var(--transition);
}
.rank{font-weight:700;color:var(--accent)}
.name{display:flex;align-items:center;gap:12px}
.avatar{width:40px;height:40px;border-radius:10px;overflow:hidden;box-shadow:0 0 10px rgba(255,255,255,.05)}
.avatar img{width:100%;height:100%;display:block}
.discord-tag{display:flex;align-items:center;gap:6px;font-size:.85rem;color:var(--discord);font-weight:500}
.discord-tag i{font-size:1rem}
.score{text-align:right;font-weight:600}
#loader{
  position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;
  align-items:center;justify-content:center;transition:opacity 700ms ease;z-index:10;
}
#logo{
  font-size:2.5rem;font-weight:900;text-transform:uppercase;color:var(--accent);
  letter-spacing:2px;animation:glow 2s infinite alternate;cursor:pointer;
}
@keyframes glow{
  from{text-shadow:0 0 5px var(--accent);opacity:.7}
  to{text-shadow:0 0 25px var(--accent),0 0 50px var(--accent);opacity:1}
}
.hidden{opacity:0;pointer-events:none}
footer{margin-top:30px;text-align:center;font-size:.8rem;color:var(--muted)}
.last-updated{font-size:.75rem;color:var(--muted);text-align:center;margin-top:10px}
.loading-msg{font-style:italic;color:#aaa;margin-top:8px}

/* ---------- Login ---------- */
#login-page form{max-width:320px;margin:0 auto;background:var(--panel);padding:24px;border-radius:12px;box-shadow:0 0 20px rgba(0,0,0,.5)}
#login-page input{width:100%;padding:10px;margin:8px 0;border:none;border-radius:6px;background:rgba(255,255,255,.08);color:var(--text)}
#login-page button{width:100%;padding:12px;margin-top:12px;background:var(--accent);color:#000;border:none;border-radius:6px;font-weight:600;cursor:pointer}
#login-error{color:#f66;margin-top:8px;text-align:center}

/* ---------- Edit panel ---------- */
#edit-panel{margin-top:24px;background:var(--panel);padding:16px;border-radius:8px}
#edit-panel textarea{width:100%;height:180px;background:#222;color:#fff;padding:8px;border-radius:6px}
#edit-panel button{margin-top:8px;background:#4caf50;color:#fff}
</style>
</head>
<body>
<div id="loader">
  <div id="logo">GOONING</div>
  <div style="margin-top:12px;color:#777;">Click to enter</div>
</div>

<!-- ==================== LOGIN ==================== -->
<div id="login-page" class="hidden">
  <h1>Login</h1>
  <form id="login-form">
    <input type="text" id="username" placeholder="Username" required autocomplete="username">
    <input type="password" id="password" placeholder="Password" required autocomplete="current-password">
    <button type="submit">Login</button>
    <div id="login-error"></div>
  </form>
</div>

<!-- ==================== MAIN APP ==================== -->
<div id="app" class="hidden">
  <h1>Leaderboard <span id="admin-badge" class="hidden" style="font-size:.6em;background:#5865F2;color:#fff;padding:2px 6px;border-radius:4px;margin-left:8px;">ADMIN</span></h1>
  <div id="loading" class="loading-msg">Loading leaderboard...</div>

  <table id="board" class="hidden">
    <thead><tr><th>Rank</th><th>Player</th><th class="score">Score</th></tr></thead>
    <tbody id="rows"></tbody>
  </table>

  <!-- ADMIN EDIT PANEL -->
  <div id="edit-panel" class="hidden">
    <h3>Edit JSON (admin only)</h3>
    <textarea id="json-editor" placeholder='[{"name":"Player","score":123,"discord":"user#1234","avatar":"https://..."}]' spellcheck="false"></textarea>
    <button id="save-json">Save &amp; Update</button>
    <div id="save-msg" style="margin-top:8px;"></div>
  </div>

  <div class="last-updated" id="updated"></div>
  <footer>Auto-updated from server • <a href="leaderboard.json" target="_blank" style="color:var(--muted)">view raw JSON</a></footer>
</div>

<script>
/* ---------- GLOBALS ---------- */
const API = location.origin + '/api';
let currentUser = null;          // {username, role}
let leaderboardData = [];

/* ---------- UI HELPERS ---------- */
const $ = id => document.getElementById(id);
const hide = el => el.classList.add('hidden');
const show = el => el.classList.remove('hidden');
const fadeOut = el => el.style.opacity = '0';
const fadeIn  = el => el.style.opacity = '1';

/* ---------- LOADER → LOGIN ---------- */
$('logo').addEventListener('click', () => {
  $('loader').classList.add('hidden');
  setTimeout(() => {
    $('loader').style.display = 'none';
    show($('login-page'));
  }, 700);
});

/* ---------- LOGIN ---------- */
$('login-form').addEventListener('submit', async e => {
  e.preventDefault();
  const username = $('username').value.trim();
  const password = $('password').value;
  const err = $('login-error');

  try {
    const res = await fetch(`${API}/login`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({username, password})
    });
    const data = await res.json();

    if (data.success) {
      currentUser = data.user;
      hide($('login-page'));
      show($('app'));
      if (currentUser.role === 'admin') {
        show($('admin-badge'));
        show($('edit-panel'));
      }
      fetchLeaderboard();
      setInterval(fetchLeaderboard, 30_000); // refresh every 30 s
    } else {
      err.textContent = data.message || 'Login failed';
    }
  } catch (ex) {
    err.textContent = 'Network error';
    console.error(ex);
  }
});

/* ---------- FETCH LEADERBOARD ---------- */
async function fetchLeaderboard() {
  const loading = $('loading');
  const board   = $('board');
  const rows    = $('rows');
  const updated = $('updated');

  show(loading); hide(board);

  try {
    const res = await fetch(`${API}/leaderboard`);
    const data = await res.json();
    leaderboardData = data.leaderboard || [];
    const upd = data.updated || 'never';

    renderLeaderboard(leaderboardData);
    updated.textContent = `Last updated: ${upd}`;
    hide(loading); show(board);
  } catch (e) {
    console.error(e);
    loading.textContent = 'Failed to load. Check console.';
    loading.style.color = '#f66';
  }
}

/* ---------- RENDER ---------- */
function renderLeaderboard(list) {
  const rowsEl = $('rows');
  if (!list.length) {
    rowsEl.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#aaa;">No players yet.</td></tr>`;
    return;
  }
  const rows = list.map(p => `
    <tr>
      <td class="rank">#${p.rank || "?"}</td>
      <td class="name">
        <div class="avatar"><img src="${escapeHtml(p.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png')}" alt="" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'"></div>
        <div>
          <div>${escapeHtml(p.name || "Unknown")}</div>
          ${p.discord ? `<div class="discord-tag"><i class="fab fa-discord"></i>${escapeHtml(p.discord)}</div>` : ''}
        </div>
      </td>
      <td class="score">${(p.score || 0).toLocaleString()}</td>
    </tr>`).join('');
  rowsEl.innerHTML = rows;
}

/* ---------- ADMIN SAVE ---------- */
$('save-json').addEventListener('click', async () => {
  const txt = $('json-editor').value.trim();
  let payload;
  try { payload = JSON.parse(txt); } catch { 
    $('save-msg').textContent = 'Invalid JSON';
    $('save-msg').style.color = '#f66';
    return;
  }
  if (!Array.isArray(payload)) {
    $('save-msg').textContent = 'Root must be an array';
    $('save-msg').style.color = '#f66';
    return;
  }

  const token = btoa(currentUser.username); // simple token
  try {
    const res = await fetch(`${API}/leaderboard`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ leaderboard: payload })
    });
    const result = await res.json();

    if (result.success) {
      $('save-msg').textContent = `Saved! Updated at ${result.updated}`;
      $('save-msg').style.color = '#6f6';
      fetchLeaderboard();               // refresh UI instantly
    } else {
      $('save-msg').textContent = result.error || 'Failed';
      $('save-msg').style.color = '#f66';
    }
  } catch (ex) {
    console.error(ex);
    $('save-msg').textContent = 'Network error';
    $('save-msg').style.color = '#f66';
  }
});

/* ---------- UTILS ---------- */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* ---------- AUTO-FILL EDIT PANEL (admin convenience) ---------- */
document.addEventListener('DOMContentLoaded', () => {
  // after login we can pre-fill the textarea with current data
  const observer = new MutationObserver(() => {
    if (currentUser?.role === 'admin' && leaderboardData.length) {
      $('json-editor').value = JSON.stringify(leaderboardData.map(p => ({
        name: p.name,
        score: p.score,
        discord: p.discord,
        avatar: p.avatar
      })), null, 2);
      observer.disconnect();
    }
  });
  observer.observe(document.body, { childList: true, subtree: true });
});
</script>
</body>
</html>