<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GOONING ADMIN</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0a;--panel:#111;--text:#eee;--accent:#fff;--green:#4caf50;--red:#f66}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.container{max-width:420px;width:100%;background:var(--panel);padding:32px;border-radius:14px;box-shadow:0 0 40px rgba(0,0,0,.7)}
h1{font-size:1.9rem;text-align:center;margin-bottom:24px;color:var(--accent)}
input{width:100%;padding:13px;margin:10px 0;border:none;border-radius:9px;background:rgba(255,255,255,.08);color:var(--text);font-size:1rem}
button{width:100%;padding:15px;margin-top:18px;background:var(--accent);color:#000;border:none;border-radius:9px;font-weight:600;cursor:pointer}
button:hover{background:#ddd}
.error{color:var(--red);margin-top:10px;text-align:center;font-size:.95rem}
.hidden{display:none}
#access-denied{text-align:center;color:#f66;font-size:1.1rem;margin:20px 0}
</style>
</head>
<body>

<div class="container">
  <h1>GOONING ADMIN</h1>

  <!-- IP CHECK -->
  <div id="access-denied" class="hidden">
    <p><strong>ACCESS DENIED</strong></p>
    <p>Only IP <code>192.168.1.136</code> is allowed.</p>
    <p>Your IP: <span id="your-ip"></span></p>
  </div>

  <!-- ADMIN PANEL -->
  <div id="admin-panel">
    <h2>Add Player</h2>
    <input type="text" id="new-name" placeholder="Name">
    <input type="number" id="new-score" placeholder="Score" min="0">
    <input type="text" id="new-discord" placeholder="Discord (xen#0001)">
    <input type="url" id="new-avatar" placeholder="Avatar URL">
    <button id="add-btn" style="background:var(--green);color:#fff">Add Player</button>
    <div id="player-list" style="margin-top:24px"></div>
    <div id="save-status" style="margin-top:14px;font-size:.95rem"></div>
  </div>
</div>

<script>
// === CONFIG ===
const REPO = 'projectZ678/gooning-leaderboard';
const BRANCH = 'main';
const BOARD_FILE = 'leaderboard.json';
const API = 'https://api.github.com';
const TOKEN = atob('Z2l0aHViX3BhdF8xMUJMQkhIUUkwcDA0RHE4YnRTaHQ5X2dxR0FBTGlGSUN1U0tvYUFVTWM3TXNPSkNSWmNqdWJFUWVlc2FUaWhSdnJIN0FXUVlTQzNVOEZaQzg2');
const ALLOWED_IP = '192.168.1.136';

let leaderboard = [];

// === HELPERS ===
const $ = id => document.getElementById(id);
const show = el => el.classList.remove('hidden');
const hide = el => el.classList.add('hidden');
const e = t => { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; };

// === IP CHECK ===
async function checkIP() {
  try {
    const res = await fetch('https://api.ipify.org?format=json');
    const data = await res.json();
    const userIP = data.ip;
    $('#your-ip').textContent = userIP;

    if (userIP !== ALLOWED_IP) {
      hide($('#admin-panel'));
      show($('#access-denied'));
    } else {
      fetchLeaderboard();
    }
  } catch (e) {
    $('#access-denied').innerHTML = '<p>Could not verify IP. Try again.</p>';
    hide($('#admin-panel'));
    show($('#access-denied'));
  }
}

// === GITHUB API ===
async function gh(path, opts = {}) {
  const headers = { 'Authorization': `token ${TOKEN}`, 'Accept': 'application/vnd.github.v3+json' };
  if (opts.body) headers['Content-Type'] = 'application/json';
  return await fetch(`${API}/repos/${REPO}/contents/${path}`, { ...opts, headers });
}

async function getFile(path) {
  const res = await gh(path);
  if (!res.ok) return null;
  const data = await res.json();
  return { content: JSON.parse(atob(data.content)), sha: data.sha };
}

async function saveFile(path, content, sha = null) {
  const res = await gh(path, {
    method: 'PUT',
    body: JSON.stringify({ message: 'update', content: btoa(JSON.stringify(content, null, 2)), sha, branch: BRANCH })
  });
  return res.ok;
}

// === LOAD & RENDER ===
async function fetchLeaderboard() {
  let data = await getFile(BOARD_FILE);
  if (!data) {
    await saveFile(BOARD_FILE, { leaderboard: [], updated: 'never' });
    data = { content: { leaderboard: [], updated: 'never' } };
  }
  leaderboard = data.content.leaderboard.map((p, i) => ({ ...p, id: i }));
  renderAdminPanel();
}

function renderAdminPanel() {
  const list = $('player-list');
  list.innerHTML = '';
  leaderboard.forEach(p => {
    const div = document.createElement('div');
    div.style = 'padding:12px;background:rgba(255,255,255,.03);border-radius:9px;margin:10px 0;display:flex;align-items:center;gap:12px;font-size:.95rem';
    div.innerHTML = `
      <strong>${e(p.name)}</strong> â€” ${p.score} pts
      <span style="flex:1"></span>
      <button onclick="editPlayer(${p.id})" style="background:none;border:none;color:#888;cursor:pointer"><i class="fas fa-edit"></i></button>
      <button onclick="deletePlayer(${p.id})" style="background:none;border:none;color:#f66;cursor:pointer"><i class="fas fa-trash"></i></button>
    `;
    list.appendChild(div);
  });
}

// === ADD / EDIT / DELETE ===
window.editPlayer = id => {
  const p = leaderboard.find(x => x.id === id);
  $('new-name').value = p.name;
  $('new-score').value = p.score;
  $('new-discord').value = p.discord || '';
  $('new-avatar').value = p.avatar || '';
  deletePlayer(id);
};

window.deletePlayer = async id => {
  leaderboard = leaderboard.filter(x => x.id !== id);
  await saveLeaderboard();
};

$('add-btn').onclick = async () => {
  const name = $('new-name').value.trim();
  const score = parseInt($('new-score').value) || 0;
  const discord = $('new-discord').value.trim() || null;
  const avatar = $('new-avatar').value.trim() || null;

  if (!name) return $('save-status').textContent = 'Name required', $('save-status').style.color = '#f66';

  leaderboard.push({ name, score, discord, avatar, id: Date.now() });
  $('new-name').value = $('new-score').value = $('new-discord').value = $('new-avatar').value = '';
  await saveLeaderboard();
};

async function saveLeaderboard() {
  const status = $('save-status');
  const payload = { leaderboard: leaderboard.map(({id, ...p}) => p), updated: new Date().toISOString() };
  const file = await getFile(BOARD_FILE);
  const saved = await saveFile(BOARD_FILE, payload, file?.sha);
  status.textContent = saved ? 'Saved!' : 'Save failed';
  status.style.color = saved ? '#6f6' : '#f66';
}

// === START ===
checkIP();
</script>
</body>
</html>
