<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0a;--panel:#111;--text:#eee;--accent:#fff;--green:#4caf50;--red:#f66}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.container{max-width:400px;width:100%;background:var(--panel);padding:30px;border-radius:12px;box-shadow:0 0 30px rgba(0,0,0,.6)}
h1{font-size:1.8rem;text-align:center;margin-bottom:20px;color:var(--accent)}
input{width:100%;padding:12px;margin:10px 0;border:none;border-radius:8px;background:rgba(255,255,255,.08);color:var(--text);font-size:1rem}
button{width:100%;padding:14px;margin-top:16px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:600;cursor:pointer}
button:hover{background:#ccc}
.error{color:var(--red);margin-top:8px;text-align:center;font-size:.9rem}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <h1>GOONING ADMIN</h1>

  <!-- SIGNUP -->
  <div id="signup-form">
    <input type="text" id="signup-username" placeholder="Username (use XEN for admin)">
    <input type="password" id="signup-password" placeholder="Password">
    <button id="signup-btn">Create Account</button>
    <div class="error" id="signup-error"></div>
    <p style="text-align:center;margin-top:16px;font-size:.9rem">Have account? <a href="#" id="show-login" style="color:var(--accent)">Login</a></p>
  </div>

  <!-- LOGIN -->
  <div id="login-form" class="hidden">
    <input type="text" id="login-username" placeholder="Username">
    <input type="password" id="login-password" placeholder="Password">
    <button id="login-btn">Login</button>
    <div class="error" id="login-error"></div>
    <p style="text-align:center;margin-top:16px;font-size:.9rem">No account? <a href="#" id="show-signup" style="color:var(--accent)">Sign up</a></p>
  </div>

  <!-- ADMIN PANEL -->
  <div id="admin-panel" class="hidden">
    <h2>Add Player</h2>
    <input type="text" id="new-name" placeholder="Name">
    <input type="number" id="new-score" placeholder="Score" min="0">
    <input type="text" id="new-discord" placeholder="Discord (xen#0001)">
    <input type="url" id="new-avatar" placeholder="Avatar URL">
    <button id="add-btn" style="background:var(--green);color:#fff">Add Player</button>
    <div id="player-list" style="margin-top:20px"></div>
    <div id="save-status" style="margin-top:12px;font-size:.9rem"></div>
    <button id="logout-btn" style="margin-top:20px;background:#333">Logout</button>
  </div>
</div>

<script>
// === CONFIG ===
const REPO = 'projectZ678/gooning-leaderboard';
const BRANCH = 'main';
const USERS_FILE = 'users.json';
const BOARD_FILE = 'leaderboard.json';
const API = 'https://api.github.com';
const TOKEN = atob('Z2l0aHViX3BhdF8xMUJMQkhIUUkwcDA0RHE4YnRTaHQ5X2dxR0FBTGlGSUN1U0tvYUFVTWM3TXNPSkNSWmNqdWJFUWVlc2FUaWhSdnJIN0FXUVlTQzNVOEZaQzg2'); // hidden

let leaderboard = [];

// === HELPERS ===
const $ = id => document.getElementById(id);
const show = el => el.classList.remove('hidden');
const hide = el => el.classList.add('hidden');
const e = t => { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; };

// === GITHUB API ===
async function gh(path, opts = {}) {
  const headers = { 'Authorization': `token ${TOKEN}`, 'Accept': 'application/vnd.github.v3+json' };
  if (opts.body) headers['Content-Type'] = 'application/json';
  return await fetch(`${API}/repos/${REPO}/contents/${path}`, { ...opts, headers });
}

async function getFile(path) {
  const res = await gh(path);
  if (!res.ok) return null;
  const data = await res.json();
  return { content: JSON.parse(atob(data.content)), sha: data.sha };
}

async function saveFile(path, content, sha = null) {
  const res = await gh(path, {
    method: 'PUT',
    body: JSON.stringify({ message: 'update', content: btoa(JSON.stringify(content, null, 2)), sha, branch: BRANCH })
  });
  return res.ok;
}

// === SWITCH FORMS ===
$('show-login').onclick = () => { hide($('signup-form')); show($('login-form')); };
$('show-signup').onclick = () => { hide($('login-form')); show($('signup-form')); };

// === SIGNUP ===
$('signup-btn').onclick = async () => {
  const username = $('signup-username').value.trim();
  const password = $('signup-password').value;
  const err = $('signup-error');
  err.textContent = '';

  if (!username || !password) return err.textContent = 'Fill all fields';
  if (username.length < 3) return err.textContent = 'Username too short';

  let usersData = await getFile(USERS_FILE) || { content: { users: [] } };
  if (usersData.content.users.find(u => u.username === username)) return err.textContent = 'Username taken';

  const hash = btoa(password);
  const isAdmin = username.toLowerCase() === 'xen';
  usersData.content.users.push({ username, password: hash, role: isAdmin ? 'admin' : 'user' });

  const saved = await saveFile(USERS_FILE, usersData.content, usersData.sha);
  if (!saved) return err.textContent = 'Network error — check internet';

  if (isAdmin) {
    hide($('signup-form'));
    show($('admin-panel'));
    fetchLeaderboard();
  } else {
    alert('Account created! Only XEN can edit.');
  }
};

// === LOGIN ===
$('login-btn').onclick = async () => {
  const username = $('login-username').value.trim();
  const password = $('login-password').value;
  const err = $('login-error');
  err.textContent = '';

  if (!username || !password) return err.textContent = 'Fill all fields';

  const usersData = await getFile(USERS_FILE);
  if (!usersData) return err.textContent = 'No users — sign up first';

  const user = usersData.content.users.find(u => u.username === username && atob(u.password) === password);
  if (!user) return err.textContent = 'Wrong credentials';

  if (user.role === 'admin') {
    hide($('login-form'));
    show($('admin-panel'));
    fetchLeaderboard();
  } else {
    alert('Logged in! Only XEN can edit.');
  }
};

// === LOGOUT ===
$('logout-btn').onclick = () => location.reload();

// === FETCH & RENDER ===
async function fetchLeaderboard() {
  let data = await getFile(BOARD_FILE);
  if (!data) {
    await saveFile(BOARD_FILE, { leaderboard: [], updated: 'never' });
    data = { content: { leaderboard: [], updated: 'never' } };
  }
  leaderboard = data.content.leaderboard.map((p, i) => ({ ...p, id: i }));
  renderAdminPanel();
}

function renderAdminPanel() {
  const list = $('player-list');
  list.innerHTML = '';
  leaderboard.forEach(p => {
    const div = document.createElement('div');
    div.style = 'padding:10px;background:rgba(255,255,255,.03);border-radius:8px;margin:8px 0;display:flex;align-items:center;gap:10px;font-size:.9rem';
    div.innerHTML = `
      <strong>${e(p.name)}</strong> — ${p.score} pts
      <span style="flex:1"></span>
      <button onclick="editPlayer(${p.id})" style="background:none;border:none;color:#888;cursor:pointer"><i class="fas fa-edit"></i></button>
      <button onclick="deletePlayer(${p.id})" style="background:none;border:none;color:#f66;cursor:pointer"><i class="fas fa-trash"></i></button>
    `;
    list.appendChild(div);
  });
}

// === ADD / EDIT / DELETE ===
window.editPlayer = id => {
  const p = leaderboard.find(x => x.id === id);
  $('new-name').value = p.name;
  $('new-score').value = p.score;
  $('new-discord').value = p.discord || '';
  $('new-avatar').value = p.avatar || '';
  deletePlayer(id);
};

window.deletePlayer = async id => {
  leaderboard = leaderboard.filter(x => x.id !== id);
  await saveLeaderboard();
};

$('add-btn').onclick = async () => {
  const name = $('new-name').value.trim();
  const score = parseInt($('new-score').value) || 0;
  const discord = $('new-discord').value.trim() || null;
  const avatar = $('new-avatar').value.trim() || null;

  if (!name) return $('save-status').textContent = 'Name required', $('save-status').style.color = '#f66';

  leaderboard.push({ name, score, discord, avatar, id: Date.now() });
  $('new-name').value = $('new-score').value = $('new-discord').value = $('new-avatar').value = '';
  await saveLeaderboard();
};

async function saveLeaderboard() {
  const status = $('save-status');
  const payload = { leaderboard: leaderboard.map(({id, ...p}) => p), updated: new Date().toISOString() };
  const file = await getFile(BOARD_FILE);
  const saved = await saveFile(BOARD_FILE, payload, file?.sha);
  status.textContent = saved ? 'Saved!' : 'Save failed';
  status.style.color = saved ? '#6f6' : '#f66';
}
</script>
</body>
</html>